<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <title>Forum Diskusi</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="content-wrapper">
    <nav class="sidebar">
      <div class="sidebar-wrapper">
        <div class="sidebar-header">
          <h2>Forum Diskusi</h2>
        </div>
        <div class="sidebar-account">
          <p id="userName">Memuat...</p>
          <small id="userEmail">Memuat...</small>
        </div>
        <div id="chat-list-container" class="sidebar-menu">
          <div class="sidebar-chat-header">
            <h4 class="chat-list-header"><i class="fa-solid fa-people-group"></i> Grup Chat</h4>
            <button id="createGroupBtn" class="btn-sm" style="display: none;"><i class="fas fa-plus"></i></button>
          </div>
          <div class="form-group" style="margin: 0 0 1rem 0; padding: 0;">
            <input type="text" id="searchGroup" style="background: var(--gunmetal);" placeholder="Cari grup">
          </div>
          <ul id="group-list">
             </ul>
          <div class="sidebar-chat-header">
            <h4 class="chat-list-header"><i class="fa-solid fa-person"></i> Personal Chat</h4>
          </div>
          <div class="form-group" style="margin: 0 0 1rem 0; padding: 0;">
            <input type="text" id="searchUser" style="background: var(--gunmetal);" placeholder="Cari nama">
          </div>
          <ul id="user-list">
            </ul>
        </div>
        <div class="sidebar-footer">
          <button id="logoutBtn" class="logout-button"><i class="fa-solid fa-right-from-bracket"></i> Keluar</button>
          <p>V.3.0.4</p>
        </div>
      </div>
    </nav>

    <main class="main-content">
      <div class="main-wrapper">
        <header class="main-header">
          <button class="hamburger-menu" id="hamburger-menu" aria-label="Toggle sidebar" style="padding: 1rem; width: 4rem;">
                <i class="fas fa-bars"></i>
            </button>
          <div class="main-header-content">
            <h1 id="chatTitle"><i class="fas fa-comments"></i> Pilih Obrolan</h1>
                <p id="chatSubtitle">Pilih grup atau pengguna dari daftar di samping untuk memulai.</p>
          </div>
          <div class="main-header-menu">
            <ul>
              <li><button id="chatPermissionsBtn" class="btn-sm" style="display: none;"><i class="fas fa-shield-alt"></i> Izin Chat</button></li>
              <li><button id="manageMembersBtn" class="btn-sm info" style="display: none;"><i class="fas fa-users-cog"></i> Kelola Anggota</button></li>
              <li><button id="manageGroupBtn" class="btn-sm" style="display: none;"><i class="fas fa-edit"></i> Kelola Grup</button></li>
              <li><button id="guideBtn" class="btn-sm" style="display: none;"><i class="fas fa-info-circle"></i> Panduan Chat</button></li>
            </ul>
          </div>
        </header>
        <div class="content-container" id="chat-area">
          <div class="chat-messages" id="message-list">
             <p class="empty-state">Selamat datang di forum diskusi!</p>
          </div>
        </div>
        <div class="chat-input-area">
           <div id="replying-to-banner" class="reply-banner" style="display: none;">
              <div>
                  <p class="reply-banner-header">Membalas kepada <strong id="replying-to-user"></strong></p>
                  <p id="replying-to-text" class="reply-banner-text"></p>
              </div>
              <button id="cancel-reply-btn"><i class="fa-solid fa-xmark"></i></button>
           </div>
          <form id="messageForm" class="chat-form">
            <button type="button" id="mobileMenuBtn" class="mobile-menu-btn"><i class="fa-solid fa-gear"></i></button>
            <textarea id="messageInput" style="background-color: var(--light-gunmetal); height: 4.2rem; resize: none; overflow-y: auto;" placeholder="Ketik pesan" autocomplete="off" disabled></textarea>
            <button type="submit" id="sendMessageBtn" disabled><i class="fas fa-paper-plane"></i></button>
          </form>
        </div>
      </div>
    </main>
  </div>

  <div id="mobileMenuModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeMobileMenuModal"><i class="fa-solid fa-xmark"></i></span>
      <h2 style="margin: 0 0 2rem 0;">Menu Opsi</h2>
      <div class="modal-menu-list">
        <button id="modalChatPermissionsBtn" class="modal-menu-button" style="display: none;"><i class="fas fa-shield-alt"></i> Izin Chat</button>
        <button id="modalManageMembersBtn" class="modal-menu-button" style="display: none;"><i class="fas fa-users-cog"></i> Kelola Anggota</button>
        <button id="modalManageGroupBtn" class="modal-menu-button" style="display: none;"><i class="fas fa-edit"></i> Kelola Grup</button>
        <button id="modalGuideBtn" class="modal-menu-button" style="display: none;"><i class="fas fa-info-circle"></i> Panduan Chat</button>
      </div>
    </div>
  </div>


  <div id="guideModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeGuideModal"><i class="fa-solid fa-xmark"></i></span>
      <h2 style="margin: 0 0 2rem 0;">Panduan Format Chat</h2>
      <div class="card-body" style="font-size: 1.5rem; color: var(--slate-gray);">
        <ul style="list-style: none; padding: 0;">
          <li style="margin-bottom: 0.5rem;"><code style="color: var(--cyan);"># Header1</code> Judul 1</li>
          <li style="margin-bottom: 0.5rem;"><code style="color: var(--cyan);">## Header2</code> Judul 2</li>
          <li style="margin-bottom: 0.5rem;"><code style="color: var(--cyan);">### Header3</code> Judul 3</li>
          <li style="margin-bottom: 0.5rem;"><code style="color: var(--cyan);">*Teks tebal*</code> Teks tebal</li>
          <li style="margin-bottom: 0.5rem;"><code style="color: var(--cyan);">_Teks miring_</code> Teks miring</li>
          <li style="margin-bottom: 0.5rem;"><code style="color: var(--cyan);">~~Teks coret~~</code> Teks coret</li>
          <li style="margin-bottom: 0.5rem;"><code style="color: var(--cyan);">`kode inline`</code> Teks inline</li>
          <li style="margin-bottom: 0.5rem;"><code style="color: var(--cyan);">-- List nomor</code> Baris bernomor</li>
          <li style="margin-bottom: 0.5rem;"><code style="color: var(--cyan);">-* List poin</code> Baris berpoin</li>
        </ul>
      </div>
    </div>
  </div>

  <div id="reportModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeReportModal"><i class="fa-solid fa-xmark"></i></span>
      <h2 style="margin: 0 0 2rem 0;">Laporkan Pesan</h2>
      <p style="font-size: 1.5rem; color: var(--slate-gray); margin: 1rem 0;">Anda akan melaporkan pesan berikut:</p>
      <p id="reportedMessageText" class="modal-quote"></p>
      <div class="form-group">
        <label for="reportReason">Alasan Pelaporan</label>
        <select id="reportReason">
          <option value="ancaman">Ancaman atau Kekerasan</option>
          <option value="sara">Ujaran Kebencian (SARA)</option>
          <option value="cabul">Konten Tidak Pantas/Cabul</option>
          <option value="spam">Spam atau Penipuan</option>
          <option value="lainnya">Lainnya</option>
        </select>
      </div>
      <button id="submitReportBtn" style="width: 100%;">Kirim Laporan</button>
    </div>
  </div>

  <div id="createGroupModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeCreateGroupModal"><i class="fa-solid fa-xmark"></i></span>
      <h2 style="margin: 0 0 2rem 0;">Buat Grup Baru</h2>
      <form id="createGroupForm">
        <div class="form-group">
          <label for="groupNameInput">Nama Grup</label>
          <input type="text" id="groupNameInput" placeholder="Contoh: Koordinasi Proyek X" required>
        </div>
        <div class="form-group">
          <label for="groupDescriptionInput">Deskripsi Grup</label>
          <textarea id="groupDescriptionInput" placeholder="Jelaskan tujuan dari grup ini..." rows="3" style="resize: none;"></textarea>
        </div>
        <button type="submit" style="width: 100%;">Buat Grup</button>
      </form>
    </div>
  </div>

  <div id="manageMembersModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <span class="close-modal" id="closeManageMembersModal"><i class="fa-solid fa-xmark"></i></span>
      <h2 id="manageMembersTitle" style="margin: 0 0 2rem 0;">Kelola Anggota</h2>
      <div class="members-management-container">
        <div class="members-list-container">
          <h4>Anggota Saat Ini</h4>
          <ul id="currentMembersList" class="modal-user-list"></ul>
        </div>
        <div class="members-list-container">
          <h4>Tambah Anggota Baru</h4>
          <ul id="addMembersList" class="modal-user-list"></ul>
        </div>
      </div>
    </div>
  </div>

  <div id="manageGroupModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeManageGroupModal"><i class="fa-solid fa-xmark"></i></span>
      <h2 id="manageGroupTitle" style="margin: 0 0 2rem 0;">Kelola Grup</h2>
      <form id="manageGroupForm">
        <div class="form-group">
          <label for="groupNameEditInput">Nama Grup</label>
          <input type="text" id="groupNameEditInput" required>
        </div>
        <div class="form-group">
          <label for="groupDescriptionEditInput">Deskripsi Grup</label>
          <textarea id="groupDescriptionEditInput" rows="3" style="resize: none;"></textarea>
        </div>
        <button type="submit" style="width: 100%; margin-bottom: 1rem;">Simpan Perubahan</button>
      </form>
      <button id="deleteGroupBtn" class="logout-button" style="width: 100%; display: none;"><i class="fas fa-trash"></i> Hapus Grup Ini</button>
    </div>
  </div>

  <div id="chatPermissionsModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" id="closeChatPermissionsModal"><i class="fa-solid fa-xmark"></i></span>
        <h2 style="margin: 0 0 2rem 0;">Izin Mengirim Pesan</h2>
        <form id="permissionsForm">
            <div class="form-group">
                <div style="display: flex; flex-direction: column; gap: 1.5rem; font-size: 1.5rem; color: var(--light-lavender);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Semua Pengguna</span>
                        <label class="switch">
                            <input type="radio" name="permissionMode" value="all" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Hanya Admin & Super Admin</span>
                        <label class="switch">
                            <input type="radio" name="permissionMode" value="admins_only">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Pengguna Tertentu</span>
                        <label class="switch">
                            <input type="radio" name="permissionMode" value="selected_users">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            <div id="userPermissionsContainer" class="form-group" style="display: none; border-top: 1px solid var(--gunmetal); margin-top: 1rem; padding-top: 1rem;">
                <label>Pilih pengguna yang diizinkan</label>
                <ul id="userPermissionsList" class="modal-user-list" style="max-height: 200px; display: flex; flex-direction: column; gap: 1rem;"></ul>
            </div>
            <button type="submit" style="width: 100%; margin-top: 1rem;">Simpan Pengaturan</button>
        </form>
    </div>
  </div>

  <div id="editMessageModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeEditModal"><i class="fa-solid fa-xmark"></i></span>
      <h2 style="margin: 0 0 2rem 0;">Edit Pesan</h2>
      <form id="editMessageForm">
        <div class="form-group">
          <textarea id="editMessageInput" rows="5" required style="resize: none;"></textarea>
        </div>
        <button type="submit" style="width: 100%;">Simpan Perubahan</button>
      </form>
    </div>
  </div>


  <script type="module">
    import { auth, onAuthStateChanged, signOut, db, ref, onValue, update, get, set, push, serverTimestamp, query, orderByChild, equalTo, onDisconnect, limitToLast } from './firebase.js';
    import { el } from './utils.js';

    // --- Hamburger Menu & Overlay Logic ---
document.addEventListener('DOMContentLoaded', () => {
    const hamburger = document.getElementById('hamburger-menu');
    const sidebar = document.querySelector('.sidebar');
    const mainContent = document.querySelector('.main-content');

    // Toggle sidebar saat hamburger di-klik
    hamburger.addEventListener('click', (event) => {
        event.stopPropagation(); // Mencegah event klik menyebar ke elemen lain
        sidebar.classList.toggle('active');
    });

    // Menutup sidebar saat area konten utama di-klik (hanya di mode mobile)
    mainContent.addEventListener('click', () => {
        if (window.innerWidth <= 1024 && sidebar.classList.contains('active')) {
            sidebar.classList.remove('active');
        }
    });
});
// --- End Hamburger Menu Logic ---

    let currentUser = null;
    let currentUserData = null;
    let allUsers = {};
    let activeChatId = null;
    let activeGroupData = null;
    let replyingTo = null;
    let messageToReport = null;
    let messageToEdit = null;
    let chatListeners = {};
    let activeChatMessagesListener = null; // This will hold the unsubscribe function for the active chat
    
    const elements = {
        userName: document.getElementById('userName'),
        userEmail: document.getElementById('userEmail'),
        userList: document.getElementById('user-list'),
        groupList: document.getElementById('group-list'),
        searchGroup: document.getElementById('searchGroup'),
        searchUser: document.getElementById('searchUser'),
        chatTitle: document.getElementById('chatTitle'),
        chatSubtitle: document.getElementById('chatSubtitle'),
        messageList: document.getElementById('message-list'),
        messageForm: document.getElementById('messageForm'),
        messageInput: document.getElementById('messageInput'),
        sendMessageBtn: document.getElementById('sendMessageBtn'),
        logoutBtn: document.getElementById('logoutBtn'),
        replyingToBanner: document.getElementById('replying-to-banner'),
        replyingToUser: document.getElementById('replying-to-user'),
        replyingToText: document.getElementById('replying-to-text'),
        cancelReplyBtn: document.getElementById('cancel-reply-btn'),
        guideBtn: document.getElementById('guideBtn'),
        guideModal: document.getElementById('guideModal'),
        closeGuideModal: document.getElementById('closeGuideModal'),
        reportModal: document.getElementById('reportModal'),
        closeReportModal: document.getElementById('closeReportModal'),
        reportedMessageText: document.getElementById('reportedMessageText'),
        reportReason: document.getElementById('reportReason'),
        submitReportBtn: document.getElementById('submitReportBtn'),
        createGroupBtn: document.getElementById('createGroupBtn'),
        createGroupModal: document.getElementById('createGroupModal'),
        closeCreateGroupModal: document.getElementById('closeCreateGroupModal'),
        createGroupForm: document.getElementById('createGroupForm'),
        groupNameInput: document.getElementById('groupNameInput'),
        groupDescriptionInput: document.getElementById('groupDescriptionInput'),
        manageMembersBtn: document.getElementById('manageMembersBtn'),
        manageMembersModal: document.getElementById('manageMembersModal'),
        closeManageMembersModal: document.getElementById('closeManageMembersModal'),
        manageMembersTitle: document.getElementById('manageMembersTitle'),
        currentMembersList: document.getElementById('currentMembersList'),
        addMembersList: document.getElementById('addMembersList'),
        manageGroupBtn: document.getElementById('manageGroupBtn'),
        manageGroupModal: document.getElementById('manageGroupModal'),
        closeManageGroupModal: document.getElementById('closeManageGroupModal'),
        manageGroupTitle: document.getElementById('manageGroupTitle'),
        manageGroupForm: document.getElementById('manageGroupForm'),
        groupNameEditInput: document.getElementById('groupNameEditInput'),
        groupDescriptionEditInput: document.getElementById('groupDescriptionEditInput'),
        deleteGroupBtn: document.getElementById('deleteGroupBtn'),
        chatPermissionsBtn: document.getElementById('chatPermissionsBtn'),
        chatPermissionsModal: document.getElementById('chatPermissionsModal'),
        closeChatPermissionsModal: document.getElementById('closeChatPermissionsModal'),
        permissionsForm: document.getElementById('permissionsForm'),
        userPermissionsContainer: document.getElementById('userPermissionsContainer'),
        userPermissionsList: document.getElementById('userPermissionsList'),
        editMessageModal: document.getElementById('editMessageModal'),
        closeEditModal: document.getElementById('closeEditModal'),
        editMessageForm: document.getElementById('editMessageForm'),
        editMessageInput: document.getElementById('editMessageInput'),

        // New elements for the mobile menu
        mobileMenuBtn: document.getElementById('mobileMenuBtn'),
        mobileMenuModal: document.getElementById('mobileMenuModal'),
        closeMobileMenuModal: document.getElementById('closeMobileMenuModal'),
        modalChatPermissionsBtn: document.getElementById('modalChatPermissionsBtn'),
        modalManageMembersBtn: document.getElementById('modalManageMembersBtn'),
        modalManageGroupBtn: document.getElementById('modalManageGroupBtn'),
        modalGuideBtn: document.getElementById('modalGuideBtn'),
    };

    function applyTheme(theme) {
      if (theme === 'light') {
        document.body.classList.add('light-mode');
      } else {
        document.body.classList.remove('light-mode');
      }
    }

    function applyFont(font) {
      document.body.style.fontFamily = font;
    }

    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        const savedFont = localStorage.getItem('font') || "'Poppins', sans-serif";
        applyTheme(savedTheme);
        applyFont(savedFont);
    });

    onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = 'index.html'; return; }
        currentUser = user;
        const userRef = ref(db, `users/${currentUser.uid}`);

        onValue(userRef, (snapshot) => {
            if (snapshot.exists()) {
                const userData = snapshot.val();
                if (userData.locked) {
                    alert('Akun Anda telah dinonaktifkan oleh administrator. Anda akan dikeluarkan.');
                    signOut(auth).then(() => {
                        window.location.href = 'login.html';
                    });
                }
            } else {
                alert('Akun Anda tidak lagi terdaftar. Anda akan dikeluarkan.');
                signOut(auth).then(() => {
                    window.location.href = 'login.html';
                });
            }
        });

        const userSnap = await get(userRef);
        if (userSnap.exists()) {
            currentUserData = userSnap.val();
            elements.userName.textContent = currentUserData.name || 'Pengguna';
            elements.userEmail.textContent = currentUser.email;
            
            if (currentUserData.role === 'admin' || currentUserData.role === 'super admin') {
                elements.createGroupBtn.style.display = 'block';
            }

            const presenceRef = ref(db, `users/${user.uid}/online`);
            await set(presenceRef, true);
            onDisconnect(presenceRef).set(false);
        }
        
        await loadInitialChatListsAndAttachListeners();
        setupEventListeners();
    });
    
    async function loadInitialChatListsAndAttachListeners() {
        const usersSnap = await get(ref(db, 'users'));
        if (usersSnap.exists()) {
            allUsers = usersSnap.val();
        }
        const groupsSnap = await get(ref(db, 'groups'));
        const groupsData = groupsSnap.exists() ? groupsSnap.val() : {};

        renderChatLists(groupsData); 

        Object.keys(allUsers).forEach(uid => {
            if (uid === currentUser.uid) return;
            const userStatusRef = ref(db, `users/${uid}/online`);
            onValue(userStatusRef, (snapshot) => {
                const isOnline = snapshot.val();
                const chatId = [currentUser.uid, uid].sort().join('_');
                const linkElement = document.querySelector(`a[data-chat-id="${chatId}"] i.fa-user`);
                if (linkElement) {
                    linkElement.className = isOnline ? 'fa-solid fa-user status-online' : 'fa-solid fa-user status-offline';
                }
            });
        });
        
        onValue(ref(db, 'groups'), (snapshot) => {
             renderChatLists(snapshot.val() || {});
        });

        if (elements.groupList.firstChild && !activeChatId) {
            elements.groupList.firstChild.querySelector('a').click();
        }
    }
    
    function renderChatLists(groupsData) {
        const groupSearchTerm = elements.searchGroup.value.toLowerCase();
        elements.groupList.innerHTML = '';
        const generalGroup = { id: 'general', name: 'Diskusi Umum' };
        if (generalGroup.name.toLowerCase().includes(groupSearchTerm)) {
            const li = el('li');
            const a = el('a', `<span><i class="fa-solid fa-user-group"></i> ${generalGroup.name}</span>`, { href: '#', 'data-chat-id': 'general' });
            const badge = el('span', '0', { class: 'unread-badge', style: 'display: none;' });
            a.append(badge);
            a.onclick = (e) => { e.preventDefault(); openChat(generalGroup.id, generalGroup.name, 'group', generalGroup); };
            li.append(a);
            elements.groupList.append(li);
            listenForUnread(generalGroup.id, badge);
        }
        Object.entries(groupsData).forEach(([groupId, group]) => {
            if (group.name.toLowerCase().includes(groupSearchTerm)) {
                const isMember = group.members && group.members[currentUser.uid];
                const isAdmin = currentUserData.role === 'admin' || currentUserData.role === 'super admin';
                const li = el('li');
                const icon = isMember || isAdmin ? '<i class="fa-solid fa-user-group"></i>' : '<i class="fas fa-lock"></i>';
                const a = el('a', `<span>${icon} ${group.name}</span>`, { href: '#', 'data-chat-id': groupId });
                const badge = el('span', '0', { class: 'unread-badge', style: 'display: none;' });
                a.append(badge);
                a.onclick = (e) => { e.preventDefault(); openChat(groupId, group.name, 'group', {id: groupId, ...group}); };
                li.append(a);
                elements.groupList.append(li);
                if (isMember || isAdmin) {
                    listenForUnread(groupId, badge);
                }
            }
        });

        const userSearchTerm = elements.searchUser.value.toLowerCase();
        elements.userList.innerHTML = '';
        Object.entries(allUsers).forEach(([uid, userData]) => {
            if (uid === currentUser.uid) return;
            if ((userData.name || '').toLowerCase().includes(userSearchTerm)) {
                const chatId = [currentUser.uid, uid].sort().join('_');
                const li = el('li');
                const onlineIndicator = userData.online ? '<i class="fa-solid fa-user status-online"></i>' : '<i class="fa-solid fa-user status-offline"></i>';
                const a = el('a', `<span>${onlineIndicator} ${userData.name || 'Tanpa Nama'}</span>`, { href: '#', 'data-chat-id': chatId });
                const badge = el('span', '0', { class: 'unread-badge', style: 'display: none;' });
                a.append(badge);
                a.onclick = (e) => { e.preventDefault(); openChat(chatId, userData.name, 'personal', { otherUserId: uid }); };
                li.append(a);
                elements.userList.append(li);
                listenForUnread(chatId, badge);
            }
        });

        updateActiveLinkInSidebar();
    }


    function linkify(text) {
        let html = text;

        const tempElement = document.createElement('div');
        tempElement.textContent = html;
        html = tempElement.innerHTML;

        html = html.replace(/^#+\s+(.*)/gm, (match, content) => {
            const level = Math.min(match.match(/^#+/)[0].length, 6);
            return `<h${level} style="margin: 0.5em 0;">${content.trim()}</h${level}>`;
        });
        html = html.replace(/^>\s+(.*)/gm, '<blockquote style="margin: 0.5em 0; padding-left: 1em; border-left: 3px solid var(--gunmetal); color: var(--slate-gray);">$1</blockquote>');
        html = html.replace(/((?:^\s*--\s+.*\n?)+)/gm, (match) => {
            const items = match.trim().split('\n').map(line => `<li style="margin-left: 20px;">${line.replace(/^\s*--\s+/, '').trim()}</li>`).join('');
            return `<ol style="margin: 0.5em 0; padding-left: 20px;">${items}</ol>`;
        });
        html = html.replace(/((?:^\s*-\*\s+.*\n?)+)/gm, (match) => {
            const items = match.trim().split('\n').map(line => `<li style="margin-left: 20px;">${line.replace(/^\s*-\*\s+/, '').trim()}</li>`).join('');
            return `<ul style="margin: 0.5em 0; padding-left: 20px;">${items}</ul>`;
        });

        html = html.replace(/\*([^\*]+)\*/g, '<strong>$1</strong>');
        html = html.replace(/_([^_]+)_/g, '<i>$1</i>');
        html = html.replace(/~~([^~]+)~~/g, '<del>$1</del>');
        html = html.replace(/`([^`]+)`/g, '<code style="background: var(--dark-blue-gray); padding: 0.2em 0.4em; border-radius: 3px; font-family: monospace;">$1</code>');
        
        const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
        html = html.replace(urlRegex, function(url) {
            let href = url;
            if (!href.match(/^(https?|ftp|file):\/\//)) {
                href = 'https://' + href;
            }
            return `<a href="${href}" target="_blank" rel="noopener noreferrer">${url}</a>`;
        });

        return html;
    }

    function updateActiveLinkInSidebar() {
        document.querySelectorAll('#group-list a, #user-list a').forEach(link => {
            if (link.dataset.chatId === activeChatId) {
                link.classList.add('active');
            } else {
                link.classList.remove('active');
            }
        });
    }

    function listenForUnread(chatId, badgeElement) {
        const messagesRef = query(ref(db, `chats/${chatId}`), orderByChild('timestamp'));
        
        if (chatListeners[chatId]) {
            chatListeners[chatId]();
        }

        const unsubscribe = onValue(messagesRef, (snapshot) => {
            const lastRead = JSON.parse(localStorage.getItem('lastRead')) || {};
            const lastReadTime = lastRead[chatId] || 0;
            let unreadCount = 0;
            
            snapshot.forEach(child => {
                const msg = child.val();
                if (msg.timestamp > lastReadTime && msg.senderId !== currentUser.uid) {
                    unreadCount++;
                }
            });

            if (unreadCount > 0) {
                badgeElement.textContent = unreadCount > 9 ? '9+' : unreadCount;
                badgeElement.style.display = 'inline-block';
            } else {
                badgeElement.style.display = 'none';
            }
        });
        
        chatListeners[chatId] = unsubscribe;
    }
    
    function checkChatPermissions(permissions) {
        let canChat = false;
        let reason = "Anda tidak diizinkan mengirim pesan di grup ini.";

        const mode = permissions?.mode || 'all';

        if (mode === 'all') {
            canChat = true;
        } else if (mode === 'admins_only') {
            if (currentUserData.role === 'admin' || currentUserData.role === 'super admin') {
                canChat = true;
            } else {
                reason = "Hanya admin yang dapat mengirim pesan di grup ini.";
            }
        } else if (mode === 'selected_users') {
            if (permissions.allowed_users && permissions.allowed_users[currentUser.uid]) {
                canChat = true;
            } else {
                 reason = "Hanya pengguna tertentu yang dapat mengirim pesan.";
            }
        }
        
        elements.messageInput.disabled = !canChat;
        elements.sendMessageBtn.disabled = !canChat;
        if (!canChat) {
            elements.messageInput.placeholder = reason;
        } else {
            elements.messageInput.placeholder = "Ketik pesan";
        }
    }

    // =================================================================
    // BUG FIX AREA: The logic below has been completely rewritten.
    // =================================================================
    function openChat(chatId, chatName, type, metaData = null) {
        // ### FIX 1: Detach the old listener ###
        // This ensures that when you switch chats, the listener for the previous chat is turned off.
        if (activeChatMessagesListener) {
            activeChatMessagesListener();
        }

        activeChatId = chatId;
        const lastRead = JSON.parse(localStorage.getItem('lastRead')) || {};
        lastRead[chatId] = Date.now();
        localStorage.setItem('lastRead', JSON.stringify(lastRead));
        const badgeElement = document.querySelector(`a[data-chat-id="${chatId}"] .unread-badge`);
        if(badgeElement) {
            badgeElement.style.display = 'none';
        }

        updateActiveLinkInSidebar();
        
        elements.guideBtn.style.display = 'block';
        elements.modalGuideBtn.style.display = 'block'; // Show in modal
        elements.manageMembersBtn.style.display = 'none';
        elements.modalManageMembersBtn.style.display = 'none';
        elements.manageGroupBtn.style.display = 'none';
        elements.modalManageGroupBtn.style.display = 'none';
        elements.chatPermissionsBtn.style.display = 'none';
        elements.modalChatPermissionsBtn.style.display = 'none';

        if (type === 'group' && metaData && metaData.id !== 'general') {
            const isMember = metaData.members && metaData.members[currentUser.uid];
            if (!(currentUserData.role === 'admin' || currentUserData.role === 'super admin') && !isMember) {
                alert(`Maaf, sistem mendeteksi bahwa Anda bukan bagian dari grup ${chatName}`);
                return;
            }
        }
        
        activeGroupData = (type === 'group') ? metaData : null;

        if (type === 'personal') {
            const otherUserId = metaData.otherUserId;
            const otherUser = allUsers[otherUserId];
            const roleClass = (otherUser.role || '').replace(' ', '-');
            elements.chatTitle.innerHTML = `<i class="fas fa-user"></i> ${chatName} <span class="role-badge role-${roleClass}" style="font-size: 1.2rem; vertical-align: middle; margin-left: 1rem;">${otherUser.role}</span>`;
            elements.chatSubtitle.textContent = `Percakapan dengan ${chatName}`;
        } else {
            elements.chatTitle.innerHTML = `<i class="fa-solid fa-user-group"></i> ${chatName}`;
            const groupDescription = metaData && metaData.description ? metaData.description : `Grup: ${chatName}`;
            elements.chatSubtitle.textContent = groupDescription;
        }

        elements.messageInput.disabled = false;
        elements.sendMessageBtn.disabled = false;
        elements.messageList.innerHTML = '<p class="empty-state">Memuat pesan...</p>';
        
        const isSuperAdminOrAdmin = currentUserData.role === 'admin' || currentUserData.role === 'super admin';
        const isCreator = metaData && metaData.createdBy === currentUser.uid;
        
        if (type === 'group' && metaData.id !== 'general') {
            elements.manageMembersBtn.style.display = isSuperAdminOrAdmin ? 'block' : 'none';
            elements.modalManageMembersBtn.style.display = isSuperAdminOrAdmin ? 'block' : 'none';
            elements.manageGroupBtn.style.display = (isSuperAdminOrAdmin || isCreator) ? 'block' : 'none';
            elements.modalManageGroupBtn.style.display = (isSuperAdminOrAdmin || isCreator) ? 'block' : 'none';
        }
        
        if (chatId === 'general' && isSuperAdminOrAdmin) {
            elements.chatPermissionsBtn.style.display = 'block';
            elements.modalChatPermissionsBtn.style.display = 'block';
        }

        if (chatId === 'general') {
            const permissionsRef = ref(db, 'chat_settings/general/permissions');
            onValue(permissionsRef, (permSnap) => {
                checkChatPermissions(permSnap.val());
            });
        } else {
            checkChatPermissions({ mode: 'all' });
        }

        const messagesRef = query(ref(db, `chats/${activeChatId}`), orderByChild('timestamp'));
        
        // ### FIX 2: Attach the new listener and handle updates correctly ###
        activeChatMessagesListener = onValue(messagesRef, async (snapshot) => {
            // Check if the user is already scrolled to the bottom. If so, we'll auto-scroll later.
            const shouldScroll = elements.messageList.scrollTop + elements.messageList.clientHeight >= elements.messageList.scrollHeight - 30;

            const messagePromises = [];
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    // Instead of rendering directly, we create a promise for each message element
                    messagePromises.push(createMessageElement(child.key, child.val()));
                });
            }
            
            // Wait for all message elements to be created (including fetching reply data)
            const messageElements = await Promise.all(messagePromises);
            
            // Now, clear the list and append all elements at once, in the correct order.
            elements.messageList.innerHTML = '';
            if (messageElements.length > 0) {
                 messageElements.forEach(el => {
                    if(el) elements.messageList.appendChild(el);
                });
            } else {
                elements.messageList.innerHTML = `<p class="empty-state">Belum ada pesan. Mulai percakapan!</p>`;
            }
           
            // ### FIX 3: Scroll to bottom reliably ###
            // Only scroll if the user was already at the bottom, or if it's the initial load.
            if (shouldScroll) {
                elements.messageList.scrollTop = elements.messageList.scrollHeight;
            }
        });

        const sidebar = document.querySelector('.sidebar');
        if (sidebar.classList.contains('active')) {
            sidebar.classList.remove('active');
        }
    }

    // This new function's only job is to ASYNCHRONOUSLY create and RETURN a message element.
    // It does NOT add it to the DOM. This is key to fixing the race condition.
    async function createMessageElement(msgId, msgData) {
        if (msgData.deleted) {
             return null;
        }

        const isMe = msgData.senderId === currentUser.uid;
        const msgWrapper = el('div', '', { class: `message-wrapper ${isMe ? 'sent' : 'received'}`, id: `msg-${msgId}` });
        const msgBubble = el('div', '', { class: 'message-bubble' });
        
        // Handle normal message display
        const senderInfo = allUsers[msgData.senderId] || { name: 'Pengguna Dihapus', role: '' };
        const senderName = isMe ? 'Anda' : senderInfo.name;
        const senderRole = msgData.senderRole || senderInfo.role;
        const roleClass = (senderRole || '').replace(' ', '-');
        
        const headerHTML = `${senderName} <span class="role-badge role-${roleClass}" style="font-size: 1rem; vertical-align: middle;">${senderRole}</span>`;
        const header = el('p', '', { class: 'message-header' });
        header.innerHTML = headerHTML;
        msgBubble.append(header);

        // AWAIT reply data before continuing
        if (msgData.replyingToId) {
            const repliedMsgSnap = await get(ref(db, `chats/${activeChatId}/${msgData.replyingToId}`));
            if (repliedMsgSnap.exists()) {
                const repliedMsg = repliedMsgSnap.val();
                if (!repliedMsg.deleted) {
                    const isReplyingToSelf = repliedMsg.senderId === currentUser.uid;
                    const repliedHeaderName = isReplyingToSelf ? 'Anda' : (allUsers[repliedMsg.senderId]?.name || 'Pengguna Dihapus');
                    
                    const repliedMessageDiv = el('div', '', {class: 'replied-message'});
                    repliedMessageDiv.innerHTML = `<p class="replied-header">${repliedHeaderName}</p><p class="replied-text">${repliedMsg.text}</p>`;
                    msgBubble.append(repliedMessageDiv);
                }
            }
        }
        
        const text = el('div', '', { class: 'message-text' });
        text.innerHTML = linkify(msgData.text);
        const time = new Date(msgData.timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
        const editedIndicator = msgData.edited ? '<span style="font-size: 1rem; opacity: 0.7; margin-left: 0.5rem;">(telah diedit)</span>' : '';
        const footer = el('p', '', { class: 'message-footer' });
        footer.innerHTML = time + editedIndicator;
        
        const actions = el('div', '', { class: 'message-actions' });
        const replyBtn = el('button', '<i class="fas fa-reply"></i>', { class: 'btn-sm' });
        replyBtn.onclick = () => setReplyingTo(msgId, msgData);
        
        const reportBtn = el('button', '<i class="fas fa-flag"></i>', { class: 'btn-sm warm' });
        reportBtn.onclick = () => openReportModal(msgId, msgData);
        
        actions.append(replyBtn, reportBtn);

        const isAdminOrSuperAdmin = currentUserData.role === 'admin' || currentUserData.role === 'super admin';

        if (isMe) {
            const editBtn = el('button', '<i class="fas fa-edit"></i>', { class: 'btn-sm info' });
            editBtn.onclick = () => openEditModal(msgId, msgData);
            actions.append(editBtn);
        }

        if (isMe || isAdminOrSuperAdmin) {
            const deleteBtn = el('button', '<i class="fas fa-trash"></i>', { class: 'btn-sm danger' });
            deleteBtn.onclick = () => deleteMessage(msgId, msgData);
            actions.append(deleteBtn);
        }

        msgBubble.append(text, footer, actions);
        msgWrapper.append(msgBubble);

        return msgWrapper; // Return the finished element
    }
    // =================================================================
    // END OF BUG FIX AREA
    // =================================================================
    
    // ### NEW FEATURE: HARD DELETE ###
    async function deleteMessage(msgId, msgData) {
        const isMe = msgData.senderId === currentUser.uid;
        const isAdminOrSuperAdmin = currentUserData.role === 'admin' || currentUserData.role === 'super admin';
        
        if (!isMe && !isAdminOrSuperAdmin) {
            alert('Anda tidak memiliki izin untuk menghapus pesan ini.');
            return;
        }

        if (!confirm('Apakah Anda yakin ingin menghapus pesan ini secara permanen? Aksi ini tidak dapat dibatalkan.')) {
            return;
        }

        try {
            // This sets the message data to null, effectively deleting it from the database.
            await set(ref(db, `chats/${activeChatId}/${msgId}`), null);
        } catch (error) {
            console.error("Error deleting message:", error);
            alert("Gagal menghapus pesan.");
        }
    }


    function setReplyingTo(msgId, msgData) {
        const isReplyingToSelf = msgData.senderId === currentUser.uid;
        const replyToName = isReplyingToSelf ? 'Anda' : allUsers[msgData.senderId]?.name || 'Pengguna Dihapus';

        replyingTo = { id: msgId, senderName: msgData.senderName, text: msgData.text };
        elements.replyingToUser.textContent = replyToName;
        elements.replyingToText.textContent = msgData.text;
        elements.replyingToBanner.style.display = 'flex';
        elements.messageInput.focus();
    }

    function cancelReply() {
        replyingTo = null;
        elements.replyingToBanner.style.display = 'none';
    }

    function openReportModal(msgId, msgData) {
        messageToReport = { id: msgId, ...msgData };
        elements.reportedMessageText.textContent = `"${msgData.text}" oleh ${allUsers[msgData.senderId]?.name || 'Pengguna Dihapus'}`;
        elements.reportModal.style.display = 'block';
    }

    function closeReportModal() {
        elements.reportModal.style.display = 'none';
        messageToReport = null;
    }

    function openEditModal(msgId, msgData) {
        messageToEdit = { id: msgId, ...msgData };
        elements.editMessageInput.value = msgData.text;
        elements.editMessageModal.style.display = 'block';
        elements.editMessageInput.focus();
    }

    function closeEditModal() {
        elements.editMessageModal.style.display = 'none';
        messageToEdit = null;
    }

    async function handleUpdateMessage(e) {
        e.preventDefault();
        if (!messageToEdit) return;

        const newText = elements.editMessageInput.value.trim();
        if (!newText || newText === messageToEdit.text) {
            closeEditModal();
            return;
        }

        const updates = {
            text: newText,
            edited: true,
            lastEditedAt: serverTimestamp()
        };

        try {
            await update(ref(db, `chats/${activeChatId}/${messageToEdit.id}`), updates);
            closeEditModal();
        } catch (error) {
            console.error("Gagal mengedit pesan:", error);
            alert("Gagal menyimpan perubahan.");
        }
    }
    
    async function submitReport() {
        if (!messageToReport) return;
        const reportData = {
            messageId: messageToReport.id, chatId: activeChatId,
            reportedUserId: messageToReport.senderId, reporterUserId: currentUser.uid,
            messageText: messageToReport.text, reason: elements.reportReason.value,
            timestamp: serverTimestamp(), status: 'pending'
        };
        try {
            await push(ref(db, 'reports'), reportData);
            alert('Laporan Anda telah dikirim.');
            closeReportModal();
        } catch(e) {
            alert('Gagal mengirim laporan.');
            console.error(e);
        }
    }

    async function handleCreateGroup(e) {
        e.preventDefault();
        const groupName = elements.groupNameInput.value.trim();
        const groupDescription = elements.groupDescriptionInput.value.trim();
        if (!groupName) return;

        try {
            const newGroupRef = push(ref(db, 'groups'));
            await set(newGroupRef, {
                name: groupName,
                description: groupDescription,
                createdBy: currentUser.uid,
                createdAt: serverTimestamp(),
                members: { [currentUser.uid]: true }
            });
            elements.createGroupForm.reset();
            elements.createGroupModal.style.display = 'none';
        } catch (error) {
            console.error("Error creating group:", error);
            alert("Gagal membuat grup.");
        }
    }

    function openManageMembersModal() {
        if (!activeGroupData) return;
        elements.manageMembersTitle.textContent = `Kelola Anggota: ${activeGroupData.name}`;
        elements.currentMembersList.innerHTML = '';
        elements.addMembersList.innerHTML = '';

        const members = activeGroupData.members || {};
        
        Object.keys(allUsers).forEach(uid => {
            const user = allUsers[uid];
            const li = el('li', '', { class: 'modal-user-item' });
            li.textContent = user.name;

            if(members[uid]) {
                if (uid !== activeGroupData.createdBy) {
                    const removeBtn = el('button', 'Keluarkan', { class: 'btn-sm danger' });
                    removeBtn.onclick = () => removeMemberFromGroup(uid);
                    li.appendChild(removeBtn);
                } else {
                    const creatorBadge = el('span', 'Creator', { class: 'creator-badge' });
                    li.appendChild(creatorBadge);
                }
                elements.currentMembersList.appendChild(li);
            } else {
                const addBtn = el('button', 'Tambah', { class: 'btn-sm success' });
                addBtn.onclick = () => addMemberToGroup(uid);
                li.appendChild(addBtn);
                elements.addMembersList.appendChild(li);
            }
        });

        elements.manageMembersModal.style.display = 'block';
    }

    async function addMemberToGroup(userId) {
        if(!activeGroupData) return;
        const updates = {};
        updates[`/groups/${activeGroupData.id}/members/${userId}`] = true;
        await update(ref(db), updates);
        if (!activeGroupData.members) activeGroupData.members = {};
        activeGroupData.members[userId] = true;
        openManageMembersModal();
    }

    async function removeMemberFromGroup(userId) {
        if(!activeGroupData || userId === activeGroupData.createdBy) return;
        if(confirm(`Yakin ingin mengeluarkan ${allUsers[userId].name} dari grup?`)) {
            const updates = {};
            updates[`/groups/${activeGroupData.id}/members/${userId}`] = null;
            await update(ref(db), updates);
            delete activeGroupData.members[userId];
            openManageMembersModal();
        }
    }

    function openManageGroupModal() {
        if (!activeGroupData) return;
        elements.manageGroupTitle.textContent = `Kelola Grup: ${activeGroupData.name}`;
        elements.groupNameEditInput.value = activeGroupData.name || '';
        elements.groupDescriptionEditInput.value = activeGroupData.description || '';

        const isCreator = activeGroupData.createdBy === currentUser.uid;
        const isSuperAdmin = currentUserData.role === 'super admin';
        
        elements.deleteGroupBtn.style.display = (isCreator || isSuperAdmin) ? 'block' : 'none';
        
        elements.manageGroupModal.style.display = 'block';
    }

    async function handleUpdateGroup(e) {
        e.preventDefault();
        if (!activeGroupData) return;
        const newName = elements.groupNameEditInput.value.trim();
        const newDescription = elements.groupDescriptionEditInput.value.trim();
        if (!newName) {
            alert('Nama grup tidak boleh kosong.');
            return;
        }

        try {
            await update(ref(db, `groups/${activeGroupData.id}`), {
                name: newName,
                description: newDescription
            });
            alert('Informasi grup berhasil diperbarui.');
            elements.manageGroupModal.style.display = 'none';
        } catch (error) {
            console.error('Gagal memperbarui grup:', error);
            alert('Gagal memperbarui grup.');
        }
    }

    async function handleDeleteGroup() {
        if (!activeGroupData) return;
        const groupName = activeGroupData.name;
        
        if (!confirm(`PERINGATAN!\nAnda akan menghapus grup "${groupName}".\nSemua riwayat percakapan di dalam grup ini juga akan dihapus secara permanen.\n\nAksi ini tidak dapat dibatalkan. Lanjutkan?`)) {
            return;
        }

        if (!confirm(`KONFIRMASI AKHIR!\nAnda benar-benar yakin ingin menghapus grup "${groupName}"?`)) {
            return;
        }

        try {
            const updates = {};
            updates[`/groups/${activeGroupData.id}`] = null;
            updates[`/chats/${activeGroupData.id}`] = null;

            await update(ref(db), updates);
            alert(`Grup "${groupName}" telah berhasil dihapus.`);
            
            elements.manageGroupModal.style.display = 'none';
            document.querySelector('#group-list a[data-chat-id="general"]').click();

        } catch (error) {
            console.error('Gagal menghapus grup:', error);
            alert('Gagal menghapus grup.');
        }
    }
    
    function sendMessage() {
        const messageText = elements.messageInput.value.trim();
        if (!messageText || !activeChatId) return;

        const messageData = {
            senderId: currentUser.uid,
            senderName: currentUserData.name,
            senderRole: currentUserData.role,
            text: messageText,
            timestamp: serverTimestamp()
        };

        if (replyingTo) { messageData.replyingToId = replyingTo.id; }

        const newMessageRef = push(ref(db, `chats/${activeChatId}`));
        set(newMessageRef, messageData);
        
        elements.messageInput.value = '';
        cancelReply();
    }

    async function openChatPermissionsModal() {
        const permissionsSnap = await get(ref(db, 'chat_settings/general/permissions'));
        const permissions = permissionsSnap.val() || { mode: 'all' };
        
        elements.permissionsForm.querySelector(`[name="permissionMode"][value="${permissions.mode}"]`).checked = true;
        
        elements.userPermissionsList.innerHTML = '';
        Object.entries(allUsers).forEach(([uid, user]) => {
            if (user.role === 'super admin' || user.role === 'admin') return;
            const li = el('li', '', { class: 'modal-user-item', style: 'display: flex; justify-content: space-between; align-items: center; font-size: 1.5rem;' });
            const nameSpan = el('span', user.name);
            const switchLabel = el('label', '', { class: 'switch' });
            const checkbox = el('input', '', { type: 'checkbox', value: uid });
            
            if (permissions.mode === 'selected_users' && permissions.allowed_users && permissions.allowed_users[uid]) {
                checkbox.checked = true;
            }
            
            switchLabel.append(checkbox, el('span', '', {class: 'slider'}));
            li.append(nameSpan, switchLabel);
            elements.userPermissionsList.appendChild(li);
        });

        elements.userPermissionsContainer.style.display = (permissions.mode === 'selected_users') ? 'block' : 'none';
        elements.chatPermissionsModal.style.display = 'block';
    }

    async function handleSavePermissions(e) {
        e.preventDefault();
        const mode = elements.permissionsForm.querySelector('[name="permissionMode"]:checked').value;
        const updates = { mode };

        if (mode === 'selected_users') {
            updates.allowed_users = {};
            elements.userPermissionsList.querySelectorAll('input:checked').forEach(input => {
                updates.allowed_users[input.value] = true;
            });
        } else {
            updates.allowed_users = null;
        }
        
        await set(ref(db, 'chat_settings/general/permissions'), updates);
        alert('Pengaturan izin berhasil disimpan.');
        elements.chatPermissionsModal.style.display = 'none';
    }

    function setupEventListeners() {
        elements.searchGroup.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('#group-list li').forEach(li => {
                const name = li.textContent.toLowerCase();
                li.style.display = name.includes(searchTerm) ? '' : 'list-item';
            });
        });
        elements.searchUser.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('#user-list li').forEach(li => {
                const name = li.textContent.toLowerCase();
                li.style.display = name.includes(searchTerm) ? '' : 'list-item';
            });
        });

        elements.messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            sendMessage();
        });

        elements.messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        elements.logoutBtn.addEventListener('click', () => {
          if (currentUser) {
            const presenceRef = ref(db, `users/${currentUser.uid}/online`);
            set(presenceRef, false).then(() => {
              signOut(auth);
            });
          } else {
            signOut(auth);
          }
        });

        elements.cancelReplyBtn.onclick = cancelReply;

        // Mobile menu events
        elements.mobileMenuBtn.onclick = () => elements.mobileMenuModal.style.display = 'block';
        elements.closeMobileMenuModal.onclick = () => elements.mobileMenuModal.style.display = 'none';
        
        // Connect header buttons to their actions
        [elements.guideBtn, elements.modalGuideBtn].forEach(btn => btn.onclick = () => {
            elements.guideModal.style.display = 'block';
            elements.mobileMenuModal.style.display = 'none';
        });
        [elements.manageMembersBtn, elements.modalManageMembersBtn].forEach(btn => btn.onclick = () => {
            openManageMembersModal();
            elements.mobileMenuModal.style.display = 'none';
        });
        [elements.manageGroupBtn, elements.modalManageGroupBtn].forEach(btn => btn.onclick = () => {
            openManageGroupModal();
            elements.mobileMenuModal.style.display = 'none';
        });
        [elements.chatPermissionsBtn, elements.modalChatPermissionsBtn].forEach(btn => btn.onclick = () => {
            openChatPermissionsModal();
            elements.mobileMenuModal.style.display = 'none';
        });

        elements.closeGuideModal.onclick = () => elements.guideModal.style.display = 'none';
        
        elements.closeReportModal.onclick = closeReportModal;
        elements.submitReportBtn.onclick = submitReport;

        elements.createGroupBtn.onclick = () => elements.createGroupModal.style.display = 'block';
        elements.closeCreateGroupModal.onclick = () => elements.createGroupModal.style.display = 'none';
        elements.createGroupForm.addEventListener('submit', handleCreateGroup);
        
        elements.closeManageMembersModal.onclick = () => elements.manageMembersModal.style.display = 'none';
        
        elements.closeManageGroupModal.onclick = () => elements.manageGroupModal.style.display = 'none';
        elements.manageGroupForm.addEventListener('submit', handleUpdateGroup);
        elements.deleteGroupBtn.onclick = handleDeleteGroup;
        
        elements.closeChatPermissionsModal.onclick = () => elements.chatPermissionsModal.style.display = 'none';
        elements.permissionsForm.addEventListener('submit', handleSavePermissions);
        
        elements.closeEditModal.onclick = closeEditModal;
        elements.editMessageForm.addEventListener('submit', handleUpdateMessage);

        const permissionRadios = document.querySelectorAll('[name="permissionMode"]');
        permissionRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                elements.userPermissionsContainer.style.display = (e.target.value === 'selected_users') ? 'block' : 'none';
            });
        });

        window.onclick = (event) => {
            if (event.target == elements.guideModal) elements.guideModal.style.display = 'none';
            if (event.target == elements.reportModal) closeReportModal();
            if (event.target == elements.createGroupModal) elements.createGroupModal.style.display = 'none';
            if (event.target == elements.manageMembersModal) elements.manageMembersModal.style.display = 'none';
            if (event.target == elements.manageGroupModal) elements.manageGroupModal.style.display = 'none';
            if (event.target == elements.chatPermissionsModal) elements.chatPermissionsModal.style.display = 'none';
            if (event.target == elements.editMessageModal) closeEditModal();
            if (event.target == elements.mobileMenuModal) elements.mobileMenuModal.style.display = 'none'; // Close mobile menu on outside click
        };
    }
  </script>
</body>
</html>
